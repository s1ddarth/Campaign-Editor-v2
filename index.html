<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>TINEB Campaign Editor v2</title>

  <link rel="stylesheet" href="https://unpkg.com/grapesjs/dist/css/grapes.min.css">
  <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css">

  <script src="https://unpkg.com/grapesjs"></script>
  <script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>

  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: sans-serif;
    }

    .upload-container {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 100;
      background-color: #444;
      color: white;
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    .link-button {
      display: block;
      width: 100%;
      max-width: 314px;
      background-color: white;
      color: black;
      text-align: center;
      padding: 15px;
      margin-bottom: 1.2rem;
      border-radius: 10px;
      text-decoration: none;
      border: 1px solid #000000;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .link-button:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
    }

    #link-selector {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 200;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    #link-selector h2 {
        color: white;
        text-align: center;
        margin-bottom: 2rem;
    }
  </style>
</head>

<body>

  <div id="link-selector">
    <h2>Select a campaign to start editing:</h2>
    <a href="https://savekukrail.thereisnoearthb.com" class="link-button">Save Kukrail</a>
    <a href="https://savenicobar.thereisnoearthb.com" class="link-button">Save Nicobar</a>
  </div>

  <div class="upload-container">
    <label for="file-upload">Upload an HTML file:</label>
    <input type="file" id="file-upload" accept=".html">
    <button id="load-file-btn">Load</button>
    <button id="download-file-btn">Download</button>
  </div>

  <div id="gjs">
    <h1>Hello World!</h1>
    <p>Upload an HTML file or start editing now!</p>
  </div>

  <script type="text/javascript">
    const editor = grapesjs.init({
      container: '#gjs',
      height: '100vh',
      width: 'auto',
      storageManager: false,
      plugins: ['gjs-blocks-basic'],
      allowScripts: 1,
      deviceManager: {
        devices: [{
          name: 'Mobile',
          width: '400px',
          widthMedia: '(max-width: 480px)',
        }, {
          name: 'Desktop',
          width: '',
          widthMedia: '',
        }]
      },
    });

    // Register a component type for link button with editable href/text
    editor.DomComponents.addType('link-button', {
      model: {
        defaults: {
          tagName: 'a',
          classes: ['link-button'],
          attributes: {
            href: 'https://www.example.com',
            target: '_blank',
          },
          content: 'Link Button',
          traits: [
            {
              type: 'text',
              label: 'Link Text',
              name: 'content',
              changeProp: 1
            },
            {
              type: 'text',
              label: 'URL',
              name: 'href',
              changeProp: 1
            },
            {
              type: 'checkbox',
              label: 'Open in new tab',
              name: 'target',
              valueTrue: '_blank',
              valueFalse: ''
            }
          ]
        },
        init() {
          this.on('change:content', (model, value) => {
            this.set('content', value);
          });
        },
        toHTML() {
          const attr = this.getAttributes();
          return `<a class="link-button" href="${attr.href}"${attr.target ? ' target="_blank"' : ''}>${this.get('content')}</a>`;
        }
      },
      view: {
        events: {
          'dblclick': 'editContent',
          'keydown': 'handleKeydown',
          'blur': 'handleBlur'
        },
        editContent(e) {
          this.el.contentEditable = true;
          this.el.focus();
        },
        handleKeydown(e) {
          if (e.key === 'Backspace' && this.el.innerText.trim().length === 0) {
            e.preventDefault();
          }

          if (e.key === 'Enter') {
            e.preventDefault();
            this.updateContent();
            this.el.blur();
          }
        },
        handleBlur(e) {
          this.updateContent();
        },
        updateContent() {
          const newText = this.el.innerText.trim();
          if (newText) {
            this.model.set('content', newText);
          }
          this.el.contentEditable = false;
        }
      }
    });

    editor.BlockManager.add('link-button-block', {
      label: 'Link Button',
      category: 'Custom',
      content: { type: 'link-button' }
    });

    // Store the content of <head> from uploaded file
    let customHeadContent = '';

    let lastLoadedBody = null;

    // Function to execute scripts in the GrapesJS Canvas
    function executeCanvasScripts(bodyElement) {
      const canvas = editor.Canvas;
      const canvasDoc = canvas.getDocument();

      // Sequentially load external scripts to maintain order
      const externalScripts = Array.from(bodyElement.querySelectorAll('script[src]'));
      const loadScript = (index) => {
        if (index >= externalScripts.length) {
          // Run inline scripts
          let inlineScriptContent = '';
          bodyElement.querySelectorAll('script:not([src])').forEach(scriptEl => {
            // Remove DOMContentLoaded wrapper to run the code immediately
            const regex = /document\.addEventListener\(\s*['"]DOMContentLoaded['"]\s*,\s*function\s*\(\s*\)\s*\{([\s\S]*)\}\s*\);?/i;
            const match = scriptEl.innerHTML.trim().match(regex);
            if (match) {
              inlineScriptContent += match[1];
            } else {
              inlineScriptContent += scriptEl.innerHTML;
            }
            inlineScriptContent += '\n;';
          });

          if (inlineScriptContent) {
            try {
              canvas.getWindow().eval(inlineScriptContent);
            } catch (e) {
              console.error('Error executing dynamic script:', e);
            }
          }
          return;
        }

        const scriptEl = externalScripts[index];
        const newScript = canvasDoc.createElement('script');
        newScript.src = scriptEl.src;
        newScript.onload = () => loadScript(index + 1);
        canvasDoc.body.appendChild(newScript);
      };

      // Start loading scripts
      loadScript(0);
    }

    function convertRelativeUrlsToAbsolute(doc, baseUrl) {
        const attributes = ['href', 'src'];
        doc.querySelectorAll(attributes.map(attr => `[${attr}]`).join(', ')).forEach(el => {
            for (const attr of attributes) {
                const value = el.getAttribute(attr);
                if (value) {
                    if (value.startsWith('http') || value.startsWith('#') || value.startsWith('mailto:') || value.startsWith('tel:') || value.startsWith('data:')) {
                        continue;
                    }
                    try {
                        const absoluteUrl = new URL(value, baseUrl).href;
                        el.setAttribute(attr, absoluteUrl);
                    } catch (e) {
                        console.warn(`Could not resolve URL for ${attr}="${value}" with base "${baseUrl}"`);
                    }
                }
            }
        });
    }

    // Function to load HTML content into the editor
    function loadHtmlIntoEditor(htmlContent, baseUrl) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(htmlContent, 'text/html');

      if (baseUrl) {
        convertRelativeUrlsToAbsolute(doc, baseUrl);
      }

      // Store the original head and body
      customHeadContent = doc.head.innerHTML;
      lastLoadedBody = doc.body;

      const canvas = editor.Canvas;
      const canvasHead = canvas.getDocument().head;
      canvasHead.innerHTML = ''; // Clear previous head content

      // Add external stylesheets
      doc.head.querySelectorAll('link[rel="stylesheet"]').forEach(linkEl => {
        const newLink = canvas.getDocument().createElement('link');
        newLink.rel = 'stylesheet';
        newLink.href = linkEl.href;
        newLink.crossOrigin = linkEl.crossOrigin || '';
        canvasHead.appendChild(newLink);
      });

      // Add inline styles
      let inlineStyles = '';
      doc.head.querySelectorAll('style').forEach(styleEl => {
        inlineStyles += styleEl.innerHTML;
      });
      if (inlineStyles) {
        editor.setStyle(inlineStyles);
      }

      // Set the body content and then execute its scripts
      editor.setComponents(doc.body.innerHTML);
      executeCanvasScripts(doc.body);

      alert('HTML file loaded successfully!');
    }

    // Handle link selection
    const linkSelector = document.getElementById('link-selector');
    if (linkSelector) {
      linkSelector.addEventListener('click', async (e) => {
        const link = e.target.closest('a');
        if (link) {
          e.preventDefault();
          const url = link.href;
          const originalText = link.textContent;

          link.textContent = 'Loading...';

          try {
            const response = await fetch(url);
            if (!response.ok) {
              throw new Error(`Failed to fetch: ${response.statusText}`);
            }
            const htmlContent = await response.text();
            loadHtmlIntoEditor(htmlContent, url);
            linkSelector.style.display = 'none';
          } catch (error) {
            console.error('Error loading from URL:', error);
            alert('Failed to load content from the link. This might be due to CORS policy.');
            link.textContent = originalText;
          }
        }
      });
    }

    // Handle the file upload functionality
    const fileInput = document.getElementById('file-upload');
    const loadButton = document.getElementById('load-file-btn');
    loadButton.addEventListener('click', () => {
      const file = fileInput.files[0];
      if (!file) {
        alert('Please select an HTML file to upload.');
        return;
      }
      const reader = new FileReader();
      reader.onload = function (e) {
        loadHtmlIntoEditor(e.target.result);
      };
      reader.onerror = function () {
        alert('Failed to read the file.');
      };
      reader.readAsText(file);
    });

    // Handle the download functionality
    const downloadButton = document.getElementById('download-file-btn');
    downloadButton.addEventListener('click', () => {
      const bodyHtml = editor.getHtml();
      const css = editor.getCss();
      const finalHead = customHeadContent ? customHeadContent.replace(/<style[^>]*>[\s\S]*?<\/style>/gi, '') : `<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>My GrapesJS Page</title>`;
      const fullHtml = `<!DOCTYPE html><html lang="en"><head>${finalHead}<style>${css}</style></head><body>${bodyHtml}</body></html>`;
      const blob = new Blob([fullHtml], { type: 'text/html' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'index.html';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(a.href);
      console.log('File downloaded successfully!');
    });

    // Re-initialize scripts when entering preview mode
    editor.on('run:preview', () => {
      if (lastLoadedBody) {
        // Re-run only the inline initialization scripts
        executeCanvasScripts(lastLoadedBody);
      }
    });
  </script>

</body>

</html>